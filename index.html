<html>
<head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript"  src="https://www.google.com/jsapi"></script>

<title>Google Sheets as a Database</title>
<script type="text/javascript">

// Load the Visualization API and desired package(s).
google.load('visualization', '1.0', {'packages':['corechart','table']});
google.setOnLoadCallback(drawChart);
// Your Client ID can be retrieved from your project in the Google
// Developer Console, https://console.developers.google.com
//var CLIENT_ID = '442849890788-fhci3u8o7kb24kl2hf4ehs010gaqsch4.apps.googleusercontent.com';
var CLIENT_ID_DASH = '689505378876-4orhjal3dio2luar4quflkfvmfh3n41k.apps.googleusercontent.com';


//var SCRIPT_ID = '1qdAg8TjDF5Gw4Yu02VBNfu2j7JMPsSixbKXmAfMEnfSHrfmh8jqRqq_R';
var SCRIPT_ID_DASH = '1XQQH0QEiJB2Lcpf7EhTzNbw30qrtDw4amQnTfDvbq1HtMisKnto3SXsp';

var SCOPES = ['https://www.googleapis.com/auth/spreadsheets',
              'https://www.googleapis.com/auth/userinfo.email'];

//redraw graph when window resize is completed  
$(window).on('resizeEnd', function() {
        sendQuery();
});

function drawChart(data) {
        var dataTable = google.visualization.arrayToDataTable(data);
        var options = {
          title: 'Expenses'
        };
        var chart = new google.visualization.PieChart(document.getElementById('piechart'));
        chart.draw(dataTable, options);
}

/**
 * Check if current user has authorized this application.
 */
function checkAuth() {
    gapi.auth.authorize({
        'client_id': CLIENT_ID_DASH,
        'scope': SCOPES,
        'immediate': true
    }, handleAuthResult);
}

/**
 * Handle response from authorization server.
 *
 * @param {Object} authResult Authorization result.
 */
function handleAuthResult(authResult) {
    var authorizeDiv = document.getElementById('authorize-div');
    var loadDiv = document.getElementById('loading');
    if (authResult && !authResult.error) {
        // Hide auth UI, then load client library.
        authorizeDiv.style.display = 'none';
        loadDiv.style.display = 'block';
        callScriptFunction();
    } else {
        // Show auth UI, allowing the user to initiate authorization by
        // clicking authorize button.
        authorizeDiv.style.display = 'inline';
    }
}

/**
 * Initiate auth flow in response to user clicking authorize button.
 *
 * @param {Event} event Button click event.
 */
function handleAuthClick(event) {
        
    gapi.auth.authorize({
            client_id: CLIENT_ID_DASH,
            scope: SCOPES,
            immediate: false
        },
        handleAuthResult);
    return false;
}

/**
 * Calls an Apps Script function to get the data from the Google Sheet
 */
function callScriptFunction() {

    // Create an execution request object.
    var request = {
        'function': 'getData'
    };

    // Make the API request.
    var op = gapi.client.request({
        'root': 'https://script.googleapis.com',
        'path': 'v1/scripts/' + SCRIPT_ID_DASH + ':run',
        'method': 'POST',
        'body': request
    });

    op.execute(function(resp){ 
        handleGetDataResponse(resp);
    });
}


function handleGetDataResponse(resp) {
    if (resp.error && resp.error.status) {
        // The API encountered a problem before the script
        // started executing.
        appendPre('Error calling API:');
        appendPre(JSON.stringify(resp, null, 2));
    } else if (resp.error) {
        // The API executed, but the script returned an error.
        // Extract the first (and only) set of error details.
        // The values of this object are the script's 'errorMessage' and
        // 'errorType', and an array of stack trace elements.
        var error = resp.error.details[0];
        appendPre('Script error message: ' + error.errorMessage);
        if (error.scriptStackTraceElements) {
            // There may not be a stacktrace if the script didn't start
            // executing.
            appendPre('Script error stacktrace:');
            for (var i = 0; i < error.scriptStackTraceElements.length; i++) {
                var trace = error.scriptStackTraceElements[i];
                appendPre('\t' + trace.function+':' + trace.lineNumber);
            }
        }
    } else {
        // The structure of the result will depend upon what the Apps
        // Script function returns. 
        console.log(resp.data);
        var expenses = resp.data.expenses;
        if (Object.keys(expenses).length == 0) {
            appendPre('No expenses included!');
        } else {
            drawChart(data);
            var loadDiv = document.getElementById('loading');
            loadDiv.style.display = 'none';
        }
    }
}


jQuery(document).ready(function($) {
    $('#foo').find("input, select, button, textarea").prop("disabled", false);
    $("#foo").submit(function(event) {
        $form = $('#foo');
        var $inputs = $form.find("input, select, button, textarea");
        // serialize the data in the form
        var serializedData = $form.serializeObject();
        // Create an execution request object.
        // Create execution request.
        var request = {
            'function': 'setData',
            'parameters': serializedData,
            'devMode': true // Optional.
        };

        // Make the API request.
        var op = gapi.client.request({
            'root': 'https://script.googleapis.com',
            'path': 'v1/scripts/' + SCRIPT_ID_DASH + ':run',
            'method': 'POST',
            'body': request
        });
        op.execute(function(resp){ 
            handleGetDataResponse(resp);
        });
        // prevent default posting of form
        event.preventDefault();
    });
});


/**
 * Append a pre element to the body containing the given message
 * as its text node.
 *
 * @param {string} message Text to be placed in pre element.
 */
function appendPre(message) {
    var pre = document.getElementById('output');
    var textContent = document.createTextNode(message + '\n');
    pre.appendChild(textContent);
}


function appendComment(comment) {
    var comment_list = document.getElementById('commentlist');
    var commentNode = document.createElement("li");
    commentNode.innerHTML = "<article><header><cite><p class='comment-author-name'>" + comment.name + " - " + comment.Email + "</p></cite><time>" + comment.Timestamp + "</time></header><section class='comment-content comment'><p>" + comment.comment + "</p> </section></article>";
    comment_list.appendChild(commentNode);
}
$.fn.serializeObject = function() {
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    return o;
};
</script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<style>
.comments-area article header cite, .comments-area article header time {
    margin-left:0px;
}

.commentlist {
        font-weight: 500;
        font-family: Times;
}
.most-top {
        padding-top:15px;
}
</style>

</head>
<body>
        <div class="row most-top">
           <div class="col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-10 col-xs-offset-1">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="assets"><a href="#assets" aria-controls="assets" role="tab" data-toggle="tab">assets</a></li>
                        <li role="presentation"><a href="#expenses" aria-controls="expenses" role="tab" data-toggle="tab">expenses</a></li>
                        <li role="presentation"><a href="#targets" aria-controls="targets" role="tab" data-toggle="tab">targets</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active" id="assets">

                        Nothing to see yet

                        </div>
                        <div role="tabpanel" class="tab-pane" id="expenses">
                                
                                  <div id="authorize-div" style="display: none"> <span>Authorize access to Google Apps</span> 
                                    <!--Button for the user to click to initiate auth sequence -->
                                    <button id="authorize-button" onclick="handleAuthClick(event)"> Authorize </button>
                                  </div>
                                  <div id="output"></div>
                                  
                                  <div id="expenses" class="piechart">
                                    <div id="loading" style="display:none">
                                      <article>Loading...</article>
                                    </div>
                                  </div>
                                
                        </div>
                        <div role="tabpanel" class="tab-pane" id="targets">...</div>
                </div>
            </div>

        </div>

</body>
<script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" type="text/javascript"></script>
</html>